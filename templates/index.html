<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Forgery Detection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç Image Forgery Detection</h1>
            <p>Upload an image to detect if it has been forged or manipulated</p>
        </header>

        <div class="upload-section">
            <form id="imageForm" enctype="multipart/form-data">
                <div class="file-upload-wrapper">
                    <input type="file" id="imageInput" name="image" accept="image/*" required>
                    <label for="imageInput" class="file-upload-label">
                        <div class="upload-icon">üì∑</div>
                        <div class="upload-text">
                            <span class="upload-title">Choose an image</span>
                            <span class="upload-subtitle">PNG, JPG, JPEG, GIF, BMP (max 16MB)</span>
                        </div>
                    </label>
                </div>
                
                <div class="image-preview" id="imagePreview" style="display: none;">
                    <img id="previewImg" src="" alt="Preview">
                    <div class="image-info">
                        <span id="fileName"></span>
                        <span id="fileSize"></span>
                    </div>
                </div>
                
                <button type="submit" id="analyzeBtn" class="analyze-btn" disabled>
                    <span class="btn-text">üîç Analyze Image</span>
                    <span class="loader" style="display: none;"></span>
                </button>
            </form>
        </div>

        <div class="result-container" id="resultContainer" style="display: none;">
            <div class="result-header">
                <h3>Analysis Result</h3>
            </div>
            <div class="result-content">
                <div class="prediction-badge" id="predictionBadge">
                    <span id="predictionText"></span>
                </div>
                <div class="confidence-meter" id="confidenceMeter" style="display: none;">
                    <div class="confidence-label">Confidence Level</div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceFill"></div>
                    </div>
                    <div class="confidence-percentage" id="confidencePercentage"></div>
                </div>
            </div>
        </div>

        <div class="error-container" id="errorContainer" style="display: none;">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3>Error</h3>
            <p id="errorMessage"></p>
        </div>

        <div class="info-section">
            <h3>How it works</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-icon">üñºÔ∏è</div>
                    <h4>Upload Image</h4>
                    <p>Choose any image file from your device</p>
                </div>
                <div class="info-item">
                    <div class="info-icon">ü§ñ</div>
                    <h4>AI Analysis</h4>
                    <p>Our model analyzes the image for signs of manipulation</p>
                </div>
                <div class="info-item">
                    <div class="info-icon">‚úÖ</div>
                    <h4>Get Results</h4>
                    <p>Receive instant feedback on image authenticity</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultContainer = document.getElementById('resultContainer');
        const errorContainer = document.getElementById('errorContainer');

        // Handle file selection
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    imagePreview.style.display = 'block';
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    analyzeBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
                analyzeBtn.disabled = true;
            }
        });

        // Handle form submission
        document.getElementById('imageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btnText = analyzeBtn.querySelector('.btn-text');
            const loader = analyzeBtn.querySelector('.loader');
            
            // Show loading state
            analyzeBtn.disabled = true;
            btnText.style.display = 'none';
            loader.style.display = 'inline-block';
            resultContainer.style.display = 'none';
            errorContainer.style.display = 'none';
            
            try {
                const formData = new FormData();
                formData.append('image', imageInput.files[0]);
                
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Analysis failed');
                }
                
                // Display results
                displayResults(data);
                
            } catch (error) {
                document.getElementById('errorMessage').textContent = error.message;
                errorContainer.style.display = 'block';
            } finally {
                // Reset button state
                analyzeBtn.disabled = false;
                btnText.style.display = 'inline';
                loader.style.display = 'none';
            }
        });

        function displayResults(data) {
            const predictionBadge = document.getElementById('predictionBadge');
            const predictionText = document.getElementById('predictionText');
            const confidenceMeter = document.getElementById('confidenceMeter');
            const confidenceFill = document.getElementById('confidenceFill');
            const confidencePercentage = document.getElementById('confidencePercentage');
            
            // Set prediction text and styling
            predictionText.textContent = data.prediction;
            predictionBadge.className = `prediction-badge ${data.is_forged ? 'forged' : 'authentic'}`;
            
            // Show confidence if available
            if (data.confidence !== null) {
                confidenceMeter.style.display = 'block';
                confidenceFill.style.width = `${data.confidence_percentage}%`;
                confidencePercentage.textContent = `${data.confidence_percentage}%`;
            } else {
                confidenceMeter.style.display = 'none';
            }
            
            resultContainer.style.display = 'block';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>